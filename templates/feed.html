{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>Recent Posts</h2>
  <ul style="list-style-type: none; padding-left: 0;">
    {% for item in posts_with_likes %}
      {% with post=item.post %}
      <li class="card" style="padding: 20px;">
        <div style="display: flex; align-items: flex-start; gap: 15px;">
          <!-- Profile Picture -->
          <a href="{% url 'view_user_profile' post.user.username %}" style="flex-shrink: 0;">
            {% if post.user.profile.profile_picture %}
              <img src="{{ post.user.profile.profile_picture.url }}" alt="{{ post.user.username }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #FB8B24;">
            {% else %}
              <div style="width: 50px; height: 50px; border-radius: 50%; background-color: #5B5941; display: flex; align-items: center; justify-content: center; color: #F7EDE2; font-weight: bold; font-size: 1.2em; border: 2px solid #FB8B24;">
                {{ post.user.username|first|upper }}
              </div>
            {% endif %}
          </a>
          
          <!-- Post Content -->
          <div style="flex: 1; min-width: 0;">
            <div style="margin-bottom: 8px;">
              <a href="{% url 'view_user_profile' post.user.username %}" style="font-weight: 600; font-size: 1.05em; color: #5B5941;">
                {% if post.user.profile.display_name %}
                  {{ post.user.profile.display_name }}
                {% else %}
                  {{ post.user.username }}
                {% endif %}
              </a>
              {% if item.is_top_reviewer %}
                <span style="display: inline-flex; align-items: center; gap: 2px; background-color: rgba(251, 139, 36, 0.1); color: #FB8B24; padding: 2px 6px; border-radius: 8px; font-size: 0.65em; font-weight: 500; margin-left: 5px; border: 1px solid rgba(251, 139, 36, 0.3);">
                  <svg width="9" height="9" viewBox="0 0 24 24" fill="#FB8B24" stroke="none">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                  Top Reviewer
                </span>
              {% endif %}
              <span style="color: rgba(91, 89, 65, 0.6); font-size: 0.9em; margin-left: 8px;">@{{ post.user.username }}</span>
            </div>
            
            <h4 style="margin: 8px 0; font-size: 1.1em;">{{ post.title }}</h4>
            {% if post.menu_item %}
              <p style="margin: 5px 0; font-size: 0.9em; color: rgba(91, 89, 65, 0.7);">
                at <a href="{% url 'restaurant_detail' post.menu_item.menu.restaurant.id %}" style="color: #FB8B24; font-weight: 500;">{{ post.menu_item.menu.restaurant.name }}</a>
              </p>
            {% endif %}
            {% if post.post_type == 'review' %}
              <p class="rating" style="color: #FB8B24; font-weight: 600; margin: 5px 0;">{{ post.rating|floatformat:1 }}/10</p>
            {% endif %}
            {% if post.review_text %}<p style="margin: 10px 0; color: rgba(91, 89, 65, 0.9);">{{ post.review_text }}</p>{% endif %}
            
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 12px;">
              <p class="helper-text" style="font-size: 0.85em; color: rgba(91, 89, 65, 0.6); margin: 0;">{{ post.created_at|timesince }} ago</p>
              
              {% if item.review %}
                <a href="{% url 'like_review' item.review.id %}" id="like-btn-{{ item.review.id }}" style="display: flex; align-items: center; gap: 5px; text-decoration: none; cursor: pointer;" onclick="likeReview(event, {{ item.review.id }}, {{ item.user_has_liked|yesno:'true,false' }})">
                  <svg id="like-icon-{{ item.review.id }}" width="18" height="18" viewBox="0 0 24 24" fill="{% if item.user_has_liked %}#FB8B24{% else %}none{% endif %}" stroke="{% if item.user_has_liked %}#FB8B24{% else %}rgba(91, 89, 65, 0.6){% endif %}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                  </svg>
                  <span id="like-count-{{ item.review.id }}" style="color: rgba(91, 89, 65, 0.7); font-size: 0.9em;">{{ item.like_count }}</span>
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </li>
      {% endwith %}
    {% empty %}
      <li style="padding: 20px; text-align: center; color: rgba(91, 89, 65, 0.6);">No posts yet.</li>
    {% endfor %}
  </ul>
</div>

<script>
function likeReview(event, reviewId, currentlyLiked) {
  event.preventDefault();
  
  const icon = document.getElementById(`like-icon-${reviewId}`);
  const count = document.getElementById(`like-count-${reviewId}`);
  
  // Optimistic update
  if (currentlyLiked) {
    icon.setAttribute('fill', 'none');
    icon.setAttribute('stroke', 'rgba(91, 89, 65, 0.6)');
  } else {
    icon.setAttribute('fill', '#FB8B24');
    icon.setAttribute('stroke', '#FB8B24');
  }
  
  fetch(`/reviews/${reviewId}/like/`, {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
    }
  })
  .then(response => response.json())
  .then(data => {
    // Update with server response
    if (data.liked) {
      icon.setAttribute('fill', '#FB8B24');
      icon.setAttribute('stroke', '#FB8B24');
    } else {
      icon.setAttribute('fill', 'none');
      icon.setAttribute('stroke', 'rgba(91, 89, 65, 0.6)');
    }
    count.textContent = data.like_count;
    
    // Update the onclick handler for next click
    const btn = document.getElementById(`like-btn-${reviewId}`);
    btn.setAttribute('onclick', `likeReview(event, ${reviewId}, ${data.liked})`);
  })
  .catch(error => {
    console.error('Error:', error);
    // Revert on error
    if (currentlyLiked) {
      icon.setAttribute('fill', '#FB8B24');
      icon.setAttribute('stroke', '#FB8B24');
    } else {
      icon.setAttribute('fill', 'none');
      icon.setAttribute('stroke', 'rgba(91, 89, 65, 0.6)');
    }
  });
}
</script>
{% endblock %}
