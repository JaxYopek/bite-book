{% extends "base.html" %}
{% block content %}
<div class="container">
  <!-- Profile Header -->
  <div class="card" style="padding: 30px; margin-bottom: 30px;">
    <div style="display: flex; gap: 25px; align-items: flex-start;">
      <div style="flex-shrink: 0;">
        {% if profile.profile_picture %}
          <img src="{{ profile.profile_picture.url }}" alt="Profile Picture" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #FB8B24;">
        {% else %}
          <div style="width: 120px; height: 120px; border-radius: 50%; background-color: #5B5941; display: flex; align-items: center; justify-content: center; color: #F7EDE2; font-size: 3em; font-weight: bold; border: 3px solid #FB8B24;">
            {{ user.username|first|upper }}
          </div>
        {% endif %}
      </div>
      
      <div style="flex: 1;">
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 8px;">
          <h2 style="margin: 0;">{{ profile.display_name|default:user.username }}</h2>
          {% if is_top_reviewer %}
            <span style="display: inline-flex; align-items: center; gap: 3px; background-color: rgba(251, 139, 36, 0.1); color: #FB8B24; padding: 3px 10px; border-radius: 10px; font-size: 0.7em; font-weight: 500; border: 1px solid rgba(251, 139, 36, 0.3);">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="#FB8B24" stroke="none">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Top Reviewer
            </span>
          {% endif %}
        </div>
        <p style="color: rgba(91, 89, 65, 0.6); font-size: 0.95em; margin: 5px 0 15px 0;">@{{ user.username }}</p>
        
        <div style="display: flex; gap: 25px; margin: 15px 0;">
          <div style="text-align: center;">
            <div style="font-size: 1.5em; font-weight: bold; color: #FB8B24;">{{ user_reviews.count }}</div>
            <div style="font-size: 0.85em; color: rgba(91, 89, 65, 0.6);">Reviews</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 1.5em; font-weight: bold; color: #FB8B24;">{{ following_count }}</div>
            <div style="font-size: 0.85em; color: rgba(91, 89, 65, 0.6);">Following</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 1.5em; font-weight: bold; color: #FB8B24;">{{ followers_count }}</div>
            <div style="font-size: 0.85em; color: rgba(91, 89, 65, 0.6);">Followers</div>
          </div>
        </div>
        
        {% if flavor_profile %}
          <div style="margin: 15px 0; padding: 10px 0; border-top: 1px solid rgba(91, 89, 65, 0.1);">
            <div style="font-size: 0.75em; font-weight: 500; color: rgba(91, 89, 65, 0.5); margin-bottom: 6px;">Flavor Profile</div>
            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
              {% for cuisine, count in flavor_profile %}
                <span style="display: inline-flex; align-items: center; gap: 3px; background-color: rgba(251, 139, 36, 0.1); color: rgba(91, 89, 65, 0.7); padding: 3px 10px; border-radius: 12px; font-size: 0.75em;">
                  {{ cuisine }} <span style="color: rgba(91, 89, 65, 0.4);">·</span> {{ count }}
                </span>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        
        <a href="{% url 'edit_profile' %}"><button style="margin-top: 10px;">Edit Profile</button></a>
      </div>
    </div>
  </div>

  <!-- Favorite Restaurants -->
  <h3 style="margin: 30px 0 15px 0; display: flex; align-items: center; gap: 8px;">
    <span style="color: #FB8B24;">★</span> Favorite Restaurants
  </h3>
  {% if favorite_restaurants %}
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px;">
      {% for item in favorite_restaurants %}
        <a href="{% url 'restaurant_detail' item.restaurant.id %}" style="text-decoration: none;">
          <div class="card" style="padding: 12px 16px; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.1)';">
            <div style="font-weight: 600; font-size: 0.95em; color: #5B5941; margin-bottom: 4px; white-space: nowrap;">{{ item.restaurant.name }}</div>
            <div style="font-size: 0.75em; color: rgba(91, 89, 65, 0.6); white-space: nowrap;">{{ item.restaurant.cuisine_type }}</div>
            <div style="font-size: 0.75em; color: rgba(91, 89, 65, 0.5); margin-top: 2px; white-space: nowrap;">{{ item.restaurant.city }}</div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <p style="color: rgba(91, 89, 65, 0.6); font-style: italic; margin-bottom: 30px;">No favorite restaurants yet.</p>
  {% endif %}

  <!-- Want to Try -->
  <h3 style="margin: 30px 0 15px 0; display: flex; align-items: center; gap: 8px;">
    <span style="color: #FB8B24;">+</span> Want to Try
  </h3>
  {% if want_to_try_restaurants %}
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px;">
      {% for item in want_to_try_restaurants %}
        <a href="{% url 'restaurant_detail' item.restaurant.id %}" style="text-decoration: none;">
          <div class="card" style="padding: 12px 16px; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.1)';">
            <div style="font-weight: 600; font-size: 0.95em; color: #5B5941; margin-bottom: 4px; white-space: nowrap;">{{ item.restaurant.name }}</div>
            <div style="font-size: 0.75em; color: rgba(91, 89, 65, 0.6); white-space: nowrap;">{{ item.restaurant.cuisine_type }}</div>
            <div style="font-size: 0.75em; color: rgba(91, 89, 65, 0.5); margin-top: 2px; white-space: nowrap;">{{ item.restaurant.city }}</div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <p style="color: rgba(91, 89, 65, 0.6); font-style: italic; margin-bottom: 30px;">No restaurants on your want-to-try list yet.</p>
  {% endif %}

  <!-- Custom Lists -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px 0;">
    <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FB8B24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
      Lists
    </h3>
    <a href="{% url 'my_lists' %}" style="color: #FB8B24; font-size: 0.9em; font-weight: 500; text-decoration: none;">View All →</a>
  </div>
  {% if user_lists %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px;">
      {% for list in user_lists %}
        <a href="{% url 'view_list' list.id %}" style="text-decoration: none;">
          <div class="card" style="padding: 18px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(0,0,0,0.12)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
            <div style="display: flex; align-items: start; gap: 12px;">
              <div style="flex-shrink: 0; margin-top: 2px;">
                {% if list.list_type == 'restaurant' %}
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(91, 89, 65, 0.6)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                  </svg>
                {% else %}
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(91, 89, 65, 0.6)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                    <line x1="6" y1="1" x2="6" y2="4"></line>
                    <line x1="10" y1="1" x2="10" y2="4"></line>
                    <line x1="14" y1="1" x2="14" y2="4"></line>
                  </svg>
                {% endif %}
              </div>
              <div style="flex: 1; min-width: 0;">
                <h4 style="margin: 0 0 6px 0; color: #5B5941; font-size: 1.05em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ list.title }}</h4>
                {% if list.description %}
                  <p style="color: rgba(91, 89, 65, 0.7); margin: 0 0 8px 0; font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ list.description|truncatewords:10 }}</p>
                {% endif %}
                <div style="font-size: 0.8em; color: rgba(91, 89, 65, 0.5);">{{ list.items.count }} item{{ list.items.count|pluralize }}</div>
              </div>
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <p style="color: rgba(91, 89, 65, 0.6); font-style: italic; margin-bottom: 30px;">No lists created yet.</p>
  {% endif %}

  <!-- Recent Reviews -->
  <h3 style="margin: 30px 0 15px 0;">Recent Reviews</h3>
  {% if user_reviews %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px;">
      {% for review in user_reviews|slice:":6" %}
        <div class="card" style="padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="flex: 1;">
              <a href="{% url 'restaurant_detail' review.menu_item.menu.restaurant.id %}" style="font-weight: 600; color: #5B5941; font-size: 1.05em;">{{ review.menu_item.name }}</a>
              <div style="font-size: 0.85em; color: rgba(91, 89, 65, 0.6); margin-top: 3px;">at {{ review.menu_item.menu.restaurant.name }}</div>
            </div>
            <div style="font-size: 1.3em; font-weight: bold; color: #FB8B24; margin-left: 10px;">{{ review.rating|floatformat:1 }}</div>
          </div>
          {% if review.review_text %}
            <p style="font-size: 0.9em; color: rgba(91, 89, 65, 0.8); margin: 10px 0; line-height: 1.4;">{{ review.review_text|truncatewords:20 }}</p>
          {% endif %}
          {% if review.image %}
            <img src="{{ review.image.url }}" alt="Review photo" style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; margin-top: 10px;">
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p style="color: rgba(91, 89, 65, 0.6); font-style: italic; margin-bottom: 30px;">No reviews yet.</p>
  {% endif %}

  <!-- Recent Posts -->
  <h3 style="margin: 30px 0 15px 0; display: flex; align-items: center; justify-content: space-between;">
    <span>My Posts</span>
    <span style="font-size: 0.7em; color: rgba(91, 89, 65, 0.5); font-weight: normal;">{{ user_posts.count }} total</span>
  </h3>
  {% if user_posts %}
    <ul style="list-style-type: none; padding-left: 0;">
      {% for post in user_posts %}
        <li class="card" style="padding: 15px; margin-bottom: 10px; position: relative;" id="post-{{ post.id }}">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
            <div style="flex: 1;">
              <a href="{% url 'post_detail' post.id %}" style="text-decoration: none;">
                <h4 style="margin: 0 0 8px 0; font-size: 1.05em; color: #5B5941;">{{ post.title }}</h4>
              </a>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                <span style="display: inline-flex; align-items: center; gap: 5px; font-size: 0.75em; color: rgba(91, 89, 65, 0.6);">
                  {% if post.post_type == 'review' %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    Review
                  {% elif post.post_type == 'diary' %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 20h9"></path>
                      <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    Diary Entry
                  {% elif post.post_type == 'list' %}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="8" y1="6" x2="21" y2="6"></line>
                      <line x1="8" y1="12" x2="21" y2="12"></line>
                      <line x1="8" y1="18" x2="21" y2="18"></line>
                      <line x1="3" y1="6" x2="3.01" y2="6"></line>
                      <line x1="3" y1="12" x2="3.01" y2="12"></line>
                      <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                    List
                  {% endif %}
                </span>
                <span style="font-size: 0.75em; color: rgba(91, 89, 65, 0.5);">{{ post.created_at|timesince }} ago</span>
              </div>
          {% if post.post_type == 'review' %}
            <p style="color: #FB8B24; font-weight: 600; margin: 5px 0; font-size: 0.95em;">{{ post.rating|floatformat:1 }}/10</p>
          {% endif %}
          {% if post.review_text %}
            <p style="margin: 8px 0; font-size: 0.9em; color: rgba(91, 89, 65, 0.8);">{{ post.review_text|truncatewords:30 }}</p>
          {% endif %}
              {% if post.menu_item %}
                <p style="margin: 5px 0; font-size: 0.85em; color: rgba(91, 89, 65, 0.6);">
                  at <a href="{% url 'restaurant_detail' post.menu_item.menu.restaurant.id %}" style="color: #FB8B24;">{{ post.menu_item.menu.restaurant.name }}</a>
                </p>
              {% endif %}
            </div>
            <button onclick="deletePostProfile(event, {{ post.id }})" style="background: none; border: none; cursor: pointer; color: rgba(91, 89, 65, 0.4); padding: 8px; transition: all 0.2s; flex-shrink: 0;" onmouseover="this.style.color='#d32f2f'; this.style.transform='scale(1.1)'" onmouseout="this.style.color='rgba(91, 89, 65, 0.4)'; this.style.transform='scale(1)'" title="Delete post">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p style="color: rgba(91, 89, 65, 0.6); font-style: italic;">No posts yet.</p>
  {% endif %}
</div>

<script>
function deletePostProfile(event, postId) {
  event.preventDefault();
  
  if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
    return;
  }
  
  const postElement = document.getElementById(`post-${postId}`);
  
  fetch(`/posts/${postId}/delete/`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      postElement.style.opacity = '0';
      postElement.style.transform = 'translateX(-10px)';
      postElement.style.transition = 'all 0.3s ease';
      
      setTimeout(() => {
        postElement.remove();
        
        const postsList = document.querySelector('ul');
        if (postsList && postsList.children.length === 0) {
          postsList.innerHTML = '<p style="color: rgba(91, 89, 65, 0.6); font-style: italic;">No posts yet.</p>';
        }
      }, 300);
    } else {
      alert('Error deleting post: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting post. Please try again.');
  });
}
</script>

{% endblock %}