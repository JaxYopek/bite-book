{% extends "base.html" %}
{% block content %}
<div class="container">
  <a href="{% url 'restaurant_detail' restaurant.id %}"><button class="secondary-btn">Back to Restaurant</button></a>
  <h2>Menu for {{ restaurant.name }}</h2>
  
  <div style="margin: 20px 0;">
    <form method="get" style="display: flex; gap: 10px; align-items: center;">
      <input 
        type="text" 
        name="search" 
        value="{{ search_query }}" 
        placeholder="Search menu items..."
        style="flex: 1; padding: 12px; border: 2px solid rgba(91, 89, 65, 0.2); border-radius: 8px; font-size: 1em;"
      >
      <button type="submit" style="padding: 12px 24px; white-space: nowrap;">Search</button>
      {% if search_query %}
        <a href="{% url 'view_menu' restaurant.id %}" style="text-decoration: none;">
          <button type="button" style="background-color: #5B5941; padding: 12px 20px;">Clear</button>
        </a>
      {% endif %}
    </form>
    {% if search_query %}
      <p style="margin-top: 10px; color: rgba(91, 89, 65, 0.7); font-size: 0.9em;">Showing results for "{{ search_query }}"</p>
    {% endif %}
  </div>
  
  <h3>Menu Items</h3>
  <div id="menu-items-list">
    {% include 'menu_items_partial.html' %}
  </div>
  
  <hr style="margin: 40px 0; border: none; border-top: 2px solid rgba(91, 89, 65, 0.1);">
  
  {% if user.is_authenticated %}
  <div style="margin-bottom: 20px;">
    <h3 style="cursor: pointer; display: flex; align-items: center; gap: 10px;" onclick="toggleHappyHourSection()">
      <span id="happy-hour-toggle">▶</span>
      Happy Hour {% if happy_hours %}({{ happy_hours|length }}){% endif %}
    </h3>
    
    <div id="happy-hour-section" style="display: none; margin-top: 15px;">
      {% if happy_hours %}
        <div style="margin-bottom: 20px;">
          {% for hh in happy_hours %}
            <div style="padding: 12px; background-color: rgba(251, 139, 36, 0.05); border-left: 4px solid #FB8B24; margin-bottom: 10px; border-radius: 4px;">
              <strong style="color: #5B5941;">{{ hh.get_day_of_week_display }}</strong>
              <span style="color: rgba(91, 89, 65, 0.7);"> - {{ hh.start_time|date:"g:i A" }} to {{ hh.end_time|date:"g:i A" }}</span>
              {% if hh.specials %}
                <div style="margin-top: 5px; color: rgba(91, 89, 65, 0.8);">{{ hh.specials }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p style="color: rgba(91, 89, 65, 0.6);">No happy hour specials added yet.</p>
      {% endif %}
      
      <button type="button" onclick="toggleHappyHourForm()" style="margin-bottom: 20px;">+ Add Happy Hour</button>
    </div>
  </div>
  
  <div id="happy-hour-form" style="display: none; padding: 20px; background-color: rgba(251, 139, 36, 0.05); border-radius: 8px; margin-bottom: 20px;">
    <h4 style="margin-top: 0;">Add Happy Hour Time Slot</h4>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_happy_hour">
      
      <label>Days (select all that apply):</label>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="hh_days" value="monday" style="margin: 0; width: 18px; height: 18px; cursor: pointer;">
          <span style="margin: 0;">Monday</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="hh_days" value="tuesday" style="margin: 0; width: 18px; height: 18px; cursor: pointer;">
          <span style="margin: 0;">Tuesday</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="hh_days" value="wednesday" style="margin: 0; width: 18px; height: 18px; cursor: pointer;">
          <span style="margin: 0;">Wednesday</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="hh_days" value="thursday" style="margin: 0; width: 18px; height: 18px; cursor: pointer;">
          <span style="margin: 0;">Thursday</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="hh_days" value="friday" style="margin: 0; width: 18px; height: 18px; cursor: pointer;">
          <span style="margin: 0;">Friday</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="hh_days" value="saturday" style="margin: 0; width: 18px; height: 18px; cursor: pointer;">
          <span style="margin: 0;">Saturday</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="hh_days" value="sunday" style="margin: 0; width: 18px; height: 18px; cursor: pointer;">
          <span style="margin: 0;">Sunday</span>
        </label>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div>
          <label>Start Time:</label>
          <input type="time" name="hh_start_time" required>
        </div>
        <div>
          <label>End Time:</label>
          <input type="time" name="hh_end_time" required>
        </div>
      </div>
      
      <label>Specials:</label>
      <textarea name="hh_specials" placeholder="e.g., $5 appetizers, $6 cocktails, Half off wine" style="width: 100%; min-height: 60px; margin-bottom: 15px;"></textarea>
      
      <div style="display: flex; gap: 10px;">
        <button type="submit">Add Happy Hour</button>
        <button type="button" onclick="toggleHappyHourForm()" style="background-color: #6c757d;">Cancel</button>
      </div>
    </form>
  </div>
  
  <hr style="margin: 40px 0; border: none; border-top: 2px solid rgba(91, 89, 65, 0.1);">
  
  <h3>Add New Item</h3>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="add_item">
    <label>Name:</label>
    <input type="text" name="name" required style="text-transform: capitalize;">
    <label>Description (optional):</label>
    <textarea name="description"></textarea>
    <label>Price:</label>
    <input type="number" step="0.01" name="price" required>
    <button type="submit">Add Item</button>
  </form>
  {% else %}
  <div style="padding: 20px; background-color: rgba(251, 139, 36, 0.05); border-radius: 8px; margin: 20px 0; text-align: center;">
    <p style="color: rgba(91, 89, 65, 0.8); margin: 0;">Want to add menu items or reviews? <a href="{% url 'login' %}?next={{ request.path }}" style="color: #FB8B24; text-decoration: none; font-weight: 500;">Sign in</a> or <a href="{% url 'signup' %}?next={{ request.path }}" style="color: #FB8B24; text-decoration: none; font-weight: 500;">create an account</a></p>
  </div>
  {% endif %}
</div>

<script>
let searchTimeout = null;

function toggleHappyHourSection() {
  const section = document.getElementById('happy-hour-section');
  const toggle = document.getElementById('happy-hour-toggle');
  if (section.style.display === 'none' || section.style.display === '') {
    section.style.display = 'block';
    toggle.textContent = '▼';
  } else {
    section.style.display = 'none';
    toggle.textContent = '▶';
  }
}

function toggleHappyHourForm() {
  const form = document.getElementById('happy-hour-form');
  if (form.style.display === 'none' || form.style.display === '') {
    form.style.display = 'block';
  } else {
    form.style.display = 'none';
  }
}

// Real-time search as user types
const searchInput = document.querySelector('input[name="search"]');
if (searchInput) {
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
      searchMenuItems();
    }, 300); // Wait 300ms after user stops typing
  });
}

function searchMenuItems() {
  const searchQuery = searchInput.value;
  const url = new URL(window.location.href);
  
  if (searchQuery) {
    url.searchParams.set('search', searchQuery);
  } else {
    url.searchParams.delete('search');
  }
  
  // Update the URL without reloading
  window.history.pushState({}, '', url);
  
  // Fetch filtered results
  fetch(url, {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
    }
  })
  .then(response => response.text())
  .then(html => {
    document.getElementById('menu-items-list').innerHTML = html;
  })
  .catch(error => {
    console.error('Error:', error);
  });
}

function toggleReviews(reviewsId) {
  var reviewsDiv = document.getElementById(reviewsId);
  if (reviewsDiv.style.display === 'none') {
    reviewsDiv.style.display = 'block';
  } else {
    reviewsDiv.style.display = 'none';
  }
}

function togglePhotos(photosId) {
  var photosDiv = document.getElementById(photosId);
  if (photosDiv.style.display === 'none') {
    photosDiv.style.display = 'block';
  } else {
    photosDiv.style.display = 'none';
  }
}

function openImageModal(imageSrc) {
  var modal = document.createElement('div');
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; cursor: pointer;';
  modal.onclick = function() { document.body.removeChild(modal); };
  
  var img = document.createElement('img');
  img.src = imageSrc;
  img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
  
  modal.appendChild(img);
  document.body.appendChild(modal);
}

function likeReview(event, reviewId, currentlyLiked) {
  event.preventDefault();
  
  const icon = document.getElementById(`like-icon-${reviewId}`);
  const count = document.getElementById(`like-count-${reviewId}`);
  
  // Optimistic update
  if (currentlyLiked) {
    icon.setAttribute('fill', 'none');
    icon.setAttribute('stroke', 'rgba(91, 89, 65, 0.6)');
  } else {
    icon.setAttribute('fill', '#FB8B24');
    icon.setAttribute('stroke', '#FB8B24');
  }
  
  fetch(`/reviews/${reviewId}/like/`, {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
    }
  })
  .then(response => response.json())
  .then(data => {
    // Update with server response
    if (data.liked) {
      icon.setAttribute('fill', '#FB8B24');
      icon.setAttribute('stroke', '#FB8B24');
    } else {
      icon.setAttribute('fill', 'none');
      icon.setAttribute('stroke', 'rgba(91, 89, 65, 0.6)');
    }
    count.textContent = data.like_count;
    
    // Update the onclick handler for next click
    const btn = document.getElementById(`like-btn-${reviewId}`);
    btn.setAttribute('onclick', `likeReview(event, ${reviewId}, ${data.liked})`);
  })
  .catch(error => {
    console.error('Error:', error);
    // Revert on error
    if (currentlyLiked) {
      icon.setAttribute('fill', '#FB8B24');
      icon.setAttribute('stroke', '#FB8B24');
    } else {
      icon.setAttribute('fill', 'none');
      icon.setAttribute('stroke', 'rgba(91, 89, 65, 0.6)');
    }
  });
}

let currentItemType = '';
let currentItemId = '';

function openAddToListModal(itemType, itemId) {
  currentItemType = itemType;
  currentItemId = itemId;
  
  fetch('/api/get-user-lists/?type=' + itemType)
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById('listsContainer');
      if (data.lists && data.lists.length > 0) {
        container.innerHTML = data.lists.map(list => `
          <div onclick="addToList(${list.id})" style="padding: 15px; border: 1px solid rgba(91, 89, 65, 0.2); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.backgroundColor='rgba(251, 139, 36, 0.05)'; this.style.borderColor='#FB8B24'" onmouseout="this.style.backgroundColor=''; this.style.borderColor='rgba(91, 89, 65, 0.2)'">
            <div style="font-weight: 600; color: #5B5941; margin-bottom: 4px;">${list.title}</div>
            <div style="font-size: 0.85em; color: rgba(91, 89, 65, 0.6);">${list.item_count} items</div>
          </div>
        `).join('');
      } else {
        container.innerHTML = '<p style="text-align: center; color: rgba(91, 89, 65, 0.6); padding: 20px;">No lists yet. Create one to get started!</p>';
      }
      document.getElementById('addToListModal').style.display = 'flex';
    });
}

function closeAddToListModal() {
  document.getElementById('addToListModal').style.display = 'none';
}

function addToList(listId) {
  const formData = new FormData();
  formData.append('list_id', listId);
  formData.append('item_type', currentItemType);
  formData.append('item_id', currentItemId);
  formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
  
  fetch('{% url "add_to_list" %}', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeAddToListModal();
      alert('Added to list successfully!');
    } else {
      alert(data.error || 'Failed to add to list');
    }
  });
}

document.getElementById('addToListModal').addEventListener('click', function(e) {
  if (e.target === this) closeAddToListModal();
});
</script>

<div id="addToListModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; color: #5B5941;">Add to List</h3>
      <button onclick="closeAddToListModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: rgba(91, 89, 65, 0.5); padding: 0; width: 30px; height: 30px;">&times;</button>
    </div>
    <div id="listsContainer"></div>
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(91, 89, 65, 0.1);">
      <a href="{% url 'create_list' %}" style="text-decoration: none;">
        <button style="width: 100%; background-color: rgba(251, 139, 36, 0.1); color: #FB8B24; border: 1.5px dashed #FB8B24; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Create New List
        </button>
      </a>
    </div>
  </div>
</div>
{% endblock %}